<UserControl x:Class="Pos.Client.Wpf.Windows.Admin.UsersView"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        MinHeight="400" MinWidth="600">
    <UserControl.Resources>
        <!-- Buttons visible only when a row is selected -->
        <Style x:Key="VisibleWhenRowSelected"
               TargetType="Button">
            <Setter Property="Visibility" Value="Visible"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding SelectedItem, ElementName=UsersGrid}" Value="{x:Null}">
                    <Setter Property="Visibility" Value="Collapsed"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>
    </UserControl.Resources>

    <Grid Margin="12">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <!-- Toolbar -->
            <RowDefinition Height="*"/>
            <!-- Grid + Editor -->
            <RowDefinition Height="Auto"/>
            <!-- Tip -->
        </Grid.RowDefinitions>

        <!-- Toolbar -->
        <ToolBarTray Grid.Row="0" IsLocked="True">
            <ToolBar>
                <TextBlock Text="Users"
                           FontSize="18"
                           FontWeight="SemiBold"
                           Margin="0,0,16,0"
                           VerticalAlignment="Center"/>
                <Button Content="Refresh"
                        Click="Refresh_Click"
                        Width="100"
                        Margin="0,0,8,0"
                        />
                <Separator/>
                <Button Content="Add"
                        Click="Add_Click"
                        Width="100"
                        Margin="8,0,8,0"
                        />
                <Button Content="Edit"
                        Click="Edit_Click"
                        Width="100"
                        Margin="0,0,8,0"
                        Style="{StaticResource VisibleWhenRowSelected}"/>
                <Button Content="Delete"
                        Click="Delete_Click"
                        Width="100"
                        Margin="0,0,8,0"
                        Style="{StaticResource VisibleWhenRowSelected}"/>
                <Button Content="Outlet Assignments"
                        Click="Assignments_Click"
                        Width="170"
                        Style="{StaticResource VisibleWhenRowSelected}"/>
            </ToolBar>
        </ToolBarTray>

        <!-- Content -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition x:Name="LeftCol" Width="*" />
                <ColumnDefinition x:Name="EditorCol" Width="0" />
                <!-- collapsed by default -->
            </Grid.ColumnDefinitions>

            <!-- Users Grid -->
            <DataGrid x:Name="UsersGrid"
                      Grid.Column="0"
                      AutoGenerateColumns="False"
                      IsReadOnly="True"
                      SelectionMode="Single"
                      Style="{StaticResource ModernDataGrid}"
                      FontSize="16"
                      FontWeight="DemiBold"
                      Margin="0,0,12,0">
                <DataGrid.Columns>
                    <DataGridTextColumn Header="Username" Binding="{Binding Username}" Width="*" />
                    <DataGridTextColumn Header="Display Name" Binding="{Binding DisplayName}" Width="1.2*" />
                    <DataGridTextColumn Header="Role" Binding="{Binding Role}" Width="120" />
                    <DataGridCheckBoxColumn Header="Active" Binding="{Binding IsActive}" Width="70" />
                    <DataGridCheckBoxColumn Header="Admin" Binding="{Binding IsGlobalAdmin}" Width="70" />
                </DataGrid.Columns>
            </DataGrid>

            <!-- Inline Editor Panel (opens only when Add/Edit) -->
            <Border x:Name="EditorPanel"
        Grid.Column="1"
        Visibility="Collapsed"
        Background="{DynamicResource Panel.Background}"
        BorderBrush="{DynamicResource Panel.Border}"
        BorderThickness="1"
        CornerRadius="10"
        Padding="14"
        xmlns:sys="clr-namespace:System;assembly=mscorlib">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- Title -->
                    <TextBlock x:Name="EditorTitle"
               Text="Add User"
               FontSize="16"
               FontWeight="SemiBold" />

                    <!-- Body -->
                    <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                        <StackPanel Margin="0,10,0,10">

                            <!-- Two-column form -->
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="200"/>
                                    <!-- Label column -->
                                    <ColumnDefinition Width="*"/>
                                    <!-- Input column -->
                                </Grid.ColumnDefinitions>

                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <!-- Username -->
                                    <RowDefinition Height="Auto"/>
                                    <!-- Display Name -->
                                    <RowDefinition Height="Auto"/>
                                    <!-- Role -->
                                    <RowDefinition Height="Auto"/>
                                    <!-- Flags -->
                                    <RowDefinition Height="Auto"/>
                                    <!-- Password -->
                                    <RowDefinition Height="Auto"/>
                                    <!-- Admin-only tip -->
                                </Grid.RowDefinitions>

                                <!-- Username -->
                                <TextBlock Grid.Row="0" Grid.Column="0" Text="Username" VerticalAlignment="Center"/>
                                <TextBox   Grid.Row="0" Grid.Column="1" x:Name="EdUsername"
                     Margin="0,4,0,6" Style="{StaticResource Txt.Outlined}"/>

                                <!-- Display Name -->
                                <TextBlock Grid.Row="1" Grid.Column="0" Text="Display Name" VerticalAlignment="Center"/>
                                <TextBox   Grid.Row="1" Grid.Column="1" x:Name="EdDisplayName"
                     Margin="0,4,0,6" Style="{StaticResource Txt.Outlined}"/>

                                <!-- Role -->
                                <TextBlock Grid.Row="2" Grid.Column="0" Text="Role" VerticalAlignment="Center"/>
                                <ComboBox  Grid.Row="2" Grid.Column="1" x:Name="EdRole" Height="28" Margin="0,4,0,6">
                                    <ComboBoxItem Content="Salesman"/>
                                    <ComboBoxItem Content="Cashier"/>
                                    <ComboBoxItem Content="Supervisor"/>
                                    <ComboBoxItem Content="Manager"/>
                                    <ComboBoxItem Content="Admin"/>
                                </ComboBox>

                                <!-- Flags row -->
                                <TextBlock Grid.Row="3" Grid.Column="0" Text="" />
                                <StackPanel Grid.Row="3" Grid.Column="1" Orientation="Horizontal" Margin="0,4,0,6">
                                    <CheckBox x:Name="EdActive" Content="Active" IsChecked="True"
                      Style="{StaticResource ModernCheckBox}" Margin="0,0,16,0"/>

                                    <!-- Global Admin -->
                                    <CheckBox x:Name="EdGlobalAdmin" Content="Global Admin">
                                        <!-- show only when Role=Admin -->
                                        <CheckBox.Style>
                                            <Style TargetType="CheckBox" BasedOn="{StaticResource ModernCheckBox}">
                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                <Setter Property="IsEnabled" Value="False"/>
                                                <Style.Triggers>
                                                    <!-- Role=Admin (SelectedIndex = 4) -->
                                                    <DataTrigger Binding="{Binding ElementName=EdRole, Path=SelectedIndex}" Value="4">
                                                        <Setter Property="Visibility" Value="Visible"/>
                                                    </DataTrigger>
                                                    <!-- Enable only for users who can set GA -->
                                                    <DataTrigger Binding="{Binding DataContext.CanSetGlobalAdmin, RelativeSource={RelativeSource AncestorType=Window}}" Value="True">
                                                        <Setter Property="IsEnabled" Value="True"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </CheckBox.Style>
                                    </CheckBox>
                                </StackPanel>

                                <!-- Password (two lines) -->
                                <TextBlock Grid.Row="4" Grid.Column="0" VerticalAlignment="Center" TextWrapping="Wrap">
            <Run Text="Password"/><LineBreak/>
            <Run Text="(leave blank to keep current)"/>
                                </TextBlock>
                                <PasswordBox Grid.Row="4" Grid.Column="1" x:Name="EdPassword"
                       Margin="0,4,0,6" Height="28"
                       Style="{StaticResource Txt.Password}"/>

                                <!-- Admin-only tip (wrap + show only when Role=Admin) -->
                                <TextBlock Grid.Row="5" Grid.ColumnSpan="2"
                     FontSize="12" Opacity="0.75"
                     TextWrapping="Wrap"
                     Text="Tip: If 'Global Admin' is checked, outlet filters are bypassed. Otherwise, access is limited to the checked outlets above.">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                            <Style.Triggers>
                                                <!-- Role=Admin (SelectedIndex = 4) -->
                                                <DataTrigger Binding="{Binding ElementName=EdRole, Path=SelectedIndex}" Value="4">
                                                    <Setter Property="Visibility" Value="Visible"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                            </Grid>

                            <!-- Outlet Access -->
                            <Separator Margin="0,10,0,10"/>
                            <TextBlock Text="Outlet Access" FontWeight="SemiBold" Margin="0,0,0,6"/>

                            <DataGrid x:Name="EdOutletGrid"
                  AutoGenerateColumns="False"
                  CanUserAddRows="False"
                  CanUserDeleteRows="False"
                  HeadersVisibility="Column"
                  Margin="0,4,0,10"
                  IsReadOnly="False">
                                <DataGrid.Columns>
                                    <DataGridCheckBoxColumn Header="Access"
                                    Binding="{Binding IsAssigned, Mode=TwoWay}"
                                    Width="70" />
                                    <DataGridTextColumn Header="Outlet"
                                Binding="{Binding OutletName}"
                                IsReadOnly="True"
                                Width="*" />
                                    <DataGridComboBoxColumn Header="Role (for this outlet)"
                                    SelectedItemBinding="{Binding Role, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                    Width="180">
                                        <DataGridComboBoxColumn.ItemsSource>
                                            <x:Array Type="{x:Type sys:String}">
                                                <sys:String>Salesman</sys:String>
                                                <sys:String>Cashier</sys:String>
                                                <sys:String>Supervisor</sys:String>
                                                <sys:String>Manager</sys:String>
                                                <sys:String>Admin</sys:String>
                                            </x:Array>
                                        </DataGridComboBoxColumn.ItemsSource>
                                        <DataGridComboBoxColumn.ElementStyle>
                                            <Style TargetType="ComboBox">
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding IsAssigned}" Value="False">
                                                        <Setter Property="IsEnabled" Value="False"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </DataGridComboBoxColumn.ElementStyle>
                                        <DataGridComboBoxColumn.EditingElementStyle>
                                            <Style TargetType="ComboBox">
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding IsAssigned}" Value="False">
                                                        <Setter Property="IsEnabled" Value="False"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </DataGridComboBoxColumn.EditingElementStyle>
                                    </DataGridComboBoxColumn>
                                </DataGrid.Columns>
                            </DataGrid>
                        </StackPanel>
                    </ScrollViewer>

                    <!-- Footer -->
                    <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right">
                        <Button Content="Save" Width="110" Margin="0,0,8,0" Height="32"
              Click="SaveEditor_Click"
              Style="{StaticResource Btn.GlobalPrimary}"/>
                        <Button Content="Cancel" Width="110" Height="32"
              Click="CancelEditor_Click"
              Style="{StaticResource Btn.GlobalPrimary}"/>
                    </StackPanel>
                </Grid>
            </Border>



        </Grid>

        <TextBlock Grid.Row="2"
                   FontSize="12"
                   Opacity="0.7"
                   Text="Tip: Use 'Outlet Assignments' to set per-outlet roles (Manager, Cashier, etc.)."
                   Style="{StaticResource ModernTextBlock}"/>
    </Grid>
</UserControl>

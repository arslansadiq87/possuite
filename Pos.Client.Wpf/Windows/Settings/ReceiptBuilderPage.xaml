<UserControl x:Class="Pos.Client.Wpf.Windows.Settings.ReceiptBuilderPage"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:conv="clr-namespace:Pos.Client.Wpf.Converters"
             xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
             Width="1000" MaxWidth="1200">

    <UserControl.Resources>
        <conv:NegateBooleanConverter x:Key="NegateBool"/>
        <conv:BytesToBitmapConverter x:Key="BytesToBitmap"/>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
        <conv:NullableIntConverter x:Key="NullableIntConverter"/>
    </UserControl.Resources>

    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <!-- Header -->
            <RowDefinition Height="Auto"/>
            <!-- Scope -->
            <RowDefinition Height="*"/>
            <!-- Main (Tabs + ONE Preview) -->
            <RowDefinition Height="Auto"/>
            <!-- Actions -->
        </Grid.RowDefinitions>

        <!-- HEADER -->
        <DockPanel Grid.Row="0" LastChildFill="False" Margin="0,0,0,16">
            <StackPanel Orientation="Vertical" DockPanel.Dock="Left">
                <TextBlock Text="Receipt Builder" FontSize="18" FontWeight="SemiBold"/>
                <TextBlock
                    Text="Configure receipt layout per outlet. Printer &amp; footer come from Invoice Settings. Layout is saved per outlet (or globally)."
                    FontSize="12"
                    Foreground="{DynamicResource {x:Static SystemColors.GrayTextBrushKey}}"
                    Margin="0,2,0,0"/>
            </StackPanel>
        </DockPanel>

        <!-- SCOPE SELECTOR -->
        <Border Grid.Row="1"
                CornerRadius="4" Padding="0,6" Margin="0,0,0,16"
                Background="#0F000000" BorderBrush="#22000000" BorderThickness="1">
            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                <TextBlock Text="Scope:" VerticalAlignment="Center" Margin="8,0,16,0" FontWeight="SemiBold"/>

                <RadioButton Content="Global"
                             Margin="0,0,8,0"
                             VerticalAlignment="Center"
                             IsChecked="{Binding IsGlobal}"
                             GroupName="Scope"
                             IsEnabled="{Binding CanEditGlobal}"/>

                <RadioButton Content="Specific outlet"
                             Margin="0,0,8,0"
                             VerticalAlignment="Center"
                             IsChecked="{Binding IsGlobal, Converter={StaticResource NegateBool}}"
                             GroupName="Scope"
                             IsEnabled="{Binding CanEditGlobal}"/>

                <ComboBox Width="220" Height="26"
                          VerticalAlignment="Center"
                          VerticalContentAlignment="Center"
                          ItemsSource="{Binding OutletChoices}"
                          SelectedItem="{Binding SelectedOutlet}"
                          DisplayMemberPath="Name"
                          IsEnabled="{Binding CanEditGlobal}"
                          Margin="8,0,0,0"/>
            </StackPanel>
        </Border>

        <!-- MAIN: LEFT = Tabs (controls only), RIGHT = ONE preview -->
        <Grid Grid.Row="2">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="2*"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- LEFT: TABS -->
            <TabControl Grid.Column="0" Margin="0,0,12,0"
                        SelectedIndex="{Binding SelectedTabIndex, Mode=TwoWay}">
                <!-- =================== TAB 1: SALE =================== -->
                <TabItem Header="Sale">
                    <Border Background="#06000000" BorderBrush="#22000000" BorderThickness="1" CornerRadius="4" Padding="14">
                        <StackPanel>
                            <!-- Printer & Paper -->
                            <TextBlock Text="Printer &amp; paper" FontWeight="SemiBold" Margin="0,0,0,8"/>
                            <Grid Margin="0,0,12,8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="140"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" Text="Printer" VerticalAlignment="Center" Margin="0,0,8,0"/>
                                <TextBlock Grid.Column="1" VerticalAlignment="Center" FontWeight="SemiBold"
                                           Text="{Binding InvoicePrinterName}"/>
                            </Grid>
                            <Grid Margin="0,0,0,12">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="140"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" Text="Paper width" VerticalAlignment="Center" Margin="0,0,8,0"/>
                                <ComboBox Grid.Column="1" Width="140" Height="26" VerticalContentAlignment="Center"
                                          SelectedValue="{Binding SaleTemplate.PaperWidthMm, Mode=TwoWay}"
                                          SelectedValuePath="Tag">
                                    <ComboBoxItem Content="58 mm" Tag="58"/>
                                    <ComboBoxItem Content="80 mm" Tag="80"/>
                                    <i:Interaction.Triggers>
                                        <i:EventTrigger EventName="SelectionChanged">
                                            <i:InvokeCommandAction Command="{Binding PreviewSaleCommand}"/>
                                        </i:EventTrigger>
                                    </i:Interaction.Triggers>
                                </ComboBox>
                            </Grid>

                            <Separator Margin="0,0,0,10"/>

                            <!-- Logo -->
                            <TextBlock Text="Logo" FontWeight="SemiBold" Margin="0,0,0,8"/>
                            <Grid Margin="0,0,0,12">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <Border Grid.Column="0" BorderBrush="#33000000" BorderThickness="1" CornerRadius="4" Padding="6"
                                        Height="100" Background="#05000000" Margin="0,0,8,0">
                                    <Image Stretch="Uniform"
                                           Source="{Binding IdentityLogoBytes, Converter={StaticResource BytesToBitmap}}"/>
                                </Border>

                                <StackPanel Grid.Column="1" Margin="8,0,0,0">
                                    <CheckBox Content="Show logo" IsChecked="{Binding SaleTemplate.ShowLogoOnReceipt}">
                                        <i:Interaction.Triggers>
                                            <i:EventTrigger EventName="Checked">
                                                <i:InvokeCommandAction Command="{Binding PreviewSaleCommand}"/>
                                            </i:EventTrigger>
                                            <i:EventTrigger EventName="Unchecked">
                                                <i:InvokeCommandAction Command="{Binding PreviewSaleCommand}"/>
                                            </i:EventTrigger>
                                        </i:Interaction.Triggers>
                                    </CheckBox>

                                    <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                                        <TextBlock Text="Max width (px):" VerticalAlignment="Center"/>
                                        <TextBox Width="90" Height="26" Margin="8,0,0,0" VerticalContentAlignment="Center"
                                                 Text="{Binding SaleTemplate.LogoMaxWidthPx, UpdateSourceTrigger=PropertyChanged}">
                                            <i:Interaction.Triggers>
                                                <i:EventTrigger EventName="TextChanged">
                                                    <i:InvokeCommandAction Command="{Binding PreviewSaleCommand}"/>
                                                </i:EventTrigger>
                                            </i:Interaction.Triggers>
                                        </TextBox>
                                    </StackPanel>

                                    <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                                        <TextBlock Text="Alignment:" VerticalAlignment="Center"/>
                                        <!-- Example ComboBox for logo alignment -->
                                        <ComboBox Width="140" Height="26" SelectedItem="{Binding DataContext.SaleTemplate.LogoAlignment,
                                 RelativeSource={RelativeSource AncestorType=UserControl},
                                 Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
          ItemsSource="{Binding LogoAlignChoices}" />

                                        <i:Interaction.Triggers>
                                            <i:EventTrigger EventName="SelectionChanged">
                                                <i:InvokeCommandAction Command="{Binding PreviewSaleCommand}"/>
                                            </i:EventTrigger>
                                        </i:Interaction.Triggers>
                                    </StackPanel>
                                </StackPanel>
                            </Grid>

                            <Separator Margin="0,0,0,10"/>

                            <!-- Row visibility -->
                            <TextBlock Text="Row visibility (items)" FontWeight="SemiBold" Margin="0,0,0,8"/>
                            <WrapPanel Margin="0,0,0,12">
                                <CheckBox Content="Product name"  IsChecked="{Binding SaleTemplate.RowShowProductName}"  Margin="0,0,16,6"/>
                                <CheckBox Content="Product SKU"   IsChecked="{Binding SaleTemplate.RowShowProductSku}"   Margin="0,0,16,6"/>
                                <CheckBox Content="Quantity"      IsChecked="{Binding SaleTemplate.RowShowQty}"          Margin="0,0,16,6"/>
                                <CheckBox Content="Unit price"    IsChecked="{Binding SaleTemplate.RowShowUnitPrice}"    Margin="0,0,16,6"/>
                                <CheckBox Content="Line discount" IsChecked="{Binding SaleTemplate.RowShowLineDiscount}" Margin="0,0,16,6"/>
                                <CheckBox Content="Line total"    IsChecked="{Binding SaleTemplate.RowShowLineTotal}"    Margin="0,0,16,6"/>
                            </WrapPanel>

                            <Separator Margin="0,0,0,10"/>

                            <!-- Totals -->
                            <TextBlock Text="Totals" FontWeight="SemiBold" Margin="0,0,0,8"/>
                            <WrapPanel Margin="0,0,0,12">
                                <CheckBox Content="Taxes"             IsChecked="{Binding SaleTemplate.TotalsShowTaxes}"         Margin="0,0,16,6"/>
                                <CheckBox Content="Discounts"         IsChecked="{Binding SaleTemplate.TotalsShowDiscounts}"     Margin="0,0,16,6"/>
                                <CheckBox Content="Other expenses"    IsChecked="{Binding SaleTemplate.TotalsShowOtherExpenses}" Margin="0,0,16,6"/>
                                <CheckBox Content="Grand total"       IsChecked="{Binding SaleTemplate.TotalsShowGrandTotal}"    Margin="0,0,16,6"/>
                                <CheckBox Content="Payment received"  IsChecked="{Binding SaleTemplate.TotalsShowPaymentRecv}"   Margin="0,0,16,6"/>
                                <CheckBox Content="Balance"           IsChecked="{Binding SaleTemplate.TotalsShowBalance}"       Margin="0,0,16,6"/>
                            </WrapPanel>

                            <Separator Margin="0,0,0,10"/>
                            <StackPanel Orientation="Vertical" Margin="0,8,0,0">
                                <!-- Top margin -->
                                <DockPanel>
                                    <TextBlock Text="Top margin (lines)" Width="160"/>
                                    <TextBox Width="60"
         Text="{Binding DataContext.SaleTemplate.TopMarginLines,
                        RelativeSource={RelativeSource AncestorType=UserControl},
                        Mode=TwoWay,
                        UpdateSourceTrigger=PropertyChanged}">
                                        <i:Interaction.Triggers>
                                            <i:EventTrigger EventName="TextChanged">
                                                <i:InvokeCommandAction Command="{Binding DataContext.PreviewSaleCommand,
                                       RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                                            </i:EventTrigger>
                                        </i:Interaction.Triggers>
                                    </TextBox>

                                </DockPanel>

                                <!-- Business name -->
                                <DockPanel Margin="0,6,0,0">
                                    <CheckBox
                                    Content="Show business name"
                                    IsChecked="{Binding DataContext.SaleTemplate.ShowBusinessName,
                                                        RelativeSource={RelativeSource AncestorType=UserControl},
                                                        Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
                            
                                    <TextBlock Text="Business font size (pt)" Width="160" Margin="10,0,0,0"/>
                                    <TextBox Width="60"
         Text="{Binding DataContext.SaleTemplate.BusinessNameFontSizePt,
                        RelativeSource={RelativeSource AncestorType=UserControl},
                        Mode=TwoWay,
                        UpdateSourceTrigger=PropertyChanged,
                        Converter={StaticResource NullableIntConverter}}">
                                        <i:Interaction.Triggers>
                                            <i:EventTrigger EventName="TextChanged">
                                                <i:InvokeCommandAction Command="{Binding DataContext.PreviewSaleCommand,
                                       RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                                            </i:EventTrigger>
                                        </i:Interaction.Triggers>
                                    </TextBox>
                                    <CheckBox Content="Business name bold"
          IsChecked="{Binding DataContext.SaleTemplate.BusinessNameBold,
                              RelativeSource={RelativeSource AncestorType=UserControl},
                              Mode=TwoWay,
                              UpdateSourceTrigger=PropertyChanged}">
                                        <i:Interaction.Triggers>
                                            <i:EventTrigger EventName="Checked">
                                                <i:InvokeCommandAction Command="{Binding DataContext.PreviewSaleCommand,
                                       RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                                            </i:EventTrigger>
                                            <i:EventTrigger EventName="Unchecked">
                                                <i:InvokeCommandAction Command="{Binding DataContext.PreviewSaleCommand,
                                       RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                                            </i:EventTrigger>
                                        </i:Interaction.Triggers>
                                    </CheckBox>
                                </DockPanel>

                                <!-- Address / Contacts -->
                                <DockPanel Margin="0,8,0,0">
                                    <CheckBox
    Content="Show address"
    IsChecked="{Binding DataContext.SaleTemplate.ShowAddress,
                        RelativeSource={RelativeSource AncestorType=UserControl},
                        Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
                                    <CheckBox
    Content="Show phone"
    IsChecked="{Binding DataContext.SaleTemplate.ShowContacts,
                        RelativeSource={RelativeSource AncestorType=UserControl},
                        Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
                                </DockPanel>
                            </StackPanel>
                            <Separator Margin="0,0,0,10"/>
                            <!-- Common -->
                            <TextBlock Text="Common (sales)" FontWeight="SemiBold" Margin="0,0,0,8"/>
                            <StackPanel>
                                <CheckBox Content="Show QR"        IsChecked="{Binding SaleTemplate.ShowQr}"/>
                                <CheckBox Content="Show customer"  IsChecked="{Binding SaleTemplate.ShowCustomerOnReceipt}"/>
                                <CheckBox Content="Show cashier"   IsChecked="{Binding SaleTemplate.ShowCashierOnReceipt}"/>
                                <CheckBox Content="Print barcode"  IsChecked="{Binding SaleTemplate.PrintBarcodeOnReceipt}"/>
                                <CheckBox Content="Show NTN number" IsChecked="{Binding SaleTemplate.ShowNtnOnReceipt}" IsEnabled="{Binding RuntimeHasNtn}"/>
                                <CheckBox Content="Show FBR data (QR &amp; logo)" IsChecked="{Binding SaleTemplate.ShowFbrOnReceipt}" IsEnabled="{Binding RuntimeEnableFbr}"/>
                                <!-- Make entire invoice bold -->
                                <CheckBox Content="Make invoice bold"
          IsChecked="{Binding DataContext.ActiveTemplate.MakeAllTextBold,
                              RelativeSource={RelativeSource AncestorType=UserControl},
                              Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                                    <i:Interaction.Triggers>
                                        <i:EventTrigger EventName="Checked">
                                            <i:InvokeCommandAction Command="{Binding DataContext.PreviewSaleCommand,
                                             RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                                        </i:EventTrigger>
                                        <i:EventTrigger EventName="Unchecked">
                                            <i:InvokeCommandAction Command="{Binding DataContext.PreviewSaleCommand,
                                             RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                                        </i:EventTrigger>
                                    </i:Interaction.Triggers>
                                </CheckBox>

                            </StackPanel>
                        </StackPanel>
                    </Border>
                </TabItem>

                <!-- =================== TAB 2: SALE RETURN =================== -->
                <TabItem Header="Sale Return">
                    <Border Background="#06000000" BorderBrush="#22000000" BorderThickness="1" CornerRadius="4" Padding="14">
                        <StackPanel>
                            <!-- Bindings mirror Sale but target SaleReturnTemplate and PreviewSaleReturnCommand as needed -->
                            <TextBlock Text="Printer &amp; paper" FontWeight="SemiBold" Margin="0,0,0,8"/>
                            <Grid Margin="0,0,12,8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="140"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" Text="Printer" VerticalAlignment="Center" Margin="0,0,8,0"/>
                                <TextBlock Grid.Column="1" VerticalAlignment="Center" FontWeight="SemiBold" Text="{Binding InvoicePrinterName}"/>
                            </Grid>
                            <Grid Margin="0,0,0,12">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="140"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" Text="Paper width" VerticalAlignment="Center" Margin="0,0,8,0"/>
                                <ComboBox Grid.Column="1" Width="140" Height="26" VerticalContentAlignment="Center"
                                          SelectedValue="{Binding SaleReturnTemplate.PaperWidthMm, Mode=TwoWay}"
                                          SelectedValuePath="Tag">
                                    <ComboBoxItem Content="58 mm" Tag="58"/>
                                    <ComboBoxItem Content="80 mm" Tag="80"/>
                                    <i:Interaction.Triggers>
                                        <i:EventTrigger EventName="SelectionChanged">
                                            <i:InvokeCommandAction Command="{Binding PreviewSaleReturnCommand}"/>
                                        </i:EventTrigger>
                                    </i:Interaction.Triggers>
                                </ComboBox>
                            </Grid>

                            <Separator Margin="0,0,0,10"/>

                            <TextBlock Text="Logo" FontWeight="SemiBold" Margin="0,0,0,8"/>
                            <Grid Margin="0,0,0,12">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <Border Grid.Column="0" BorderBrush="#33000000" BorderThickness="1" CornerRadius="4" Padding="6"
                                        Height="100" Background="#05000000" Margin="0,0,8,0">
                                    <Image Stretch="Uniform"
                                           Source="{Binding IdentityLogoBytes, Converter={StaticResource BytesToBitmap}}"/>
                                </Border>

                                <StackPanel Grid.Column="1" Margin="8,0,0,0">
                                    <CheckBox Content="Show logo" IsChecked="{Binding SaleReturnTemplate.ShowLogoOnReceipt}"/>
                                    <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                                        <TextBlock Text="Max width (px):" VerticalAlignment="Center"/>
                                        <TextBox Width="90" Height="26" Margin="8,0,0,0" VerticalContentAlignment="Center"
                                                 Text="{Binding SaleReturnTemplate.LogoMaxWidthPx, UpdateSourceTrigger=PropertyChanged}"/>
                                    </StackPanel>
                                    <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                                        <TextBlock Text="Alignment:" VerticalAlignment="Center"/>
                                        <ComboBox Width="140" Height="26" Margin="8,0,0,0" VerticalContentAlignment="Center"
                                                  SelectedItem="{Binding SaleReturnTemplate.LogoAlignment, UpdateSourceTrigger=PropertyChanged}">
                                            <ComboBoxItem Content="Left"/>
                                            <ComboBoxItem Content="Center"/>
                                            <ComboBoxItem Content="Right"/>
                                        </ComboBox>
                                    </StackPanel>
                                </StackPanel>
                            </Grid>

                            <Separator Margin="0,0,0,10"/>

                            <TextBlock Text="Row visibility (items)" FontWeight="SemiBold" Margin="0,0,0,8"/>
                            <WrapPanel Margin="0,0,0,12">
                                <CheckBox Content="Product name"  IsChecked="{Binding SaleReturnTemplate.RowShowProductName}"  Margin="0,0,16,6"/>
                                <CheckBox Content="Product SKU"   IsChecked="{Binding SaleReturnTemplate.RowShowProductSku}"   Margin="0,0,16,6"/>
                                <CheckBox Content="Quantity"      IsChecked="{Binding SaleReturnTemplate.RowShowQty}"          Margin="0,0,16,6"/>
                                <CheckBox Content="Unit price"    IsChecked="{Binding SaleReturnTemplate.RowShowUnitPrice}"    Margin="0,0,16,6"/>
                                <CheckBox Content="Line discount" IsChecked="{Binding SaleReturnTemplate.RowShowLineDiscount}" Margin="0,0,16,6"/>
                                <CheckBox Content="Line total"    IsChecked="{Binding SaleReturnTemplate.RowShowLineTotal}"    Margin="0,0,16,6"/>
                            </WrapPanel>

                            <Separator Margin="0,0,0,10"/>

                            <TextBlock Text="Totals" FontWeight="SemiBold" Margin="0,0,0,8"/>
                            <WrapPanel Margin="0,0,0,12">
                                <CheckBox Content="Taxes"            IsChecked="{Binding SaleReturnTemplate.TotalsShowTaxes}"          Margin="0,0,16,6"/>
                                <CheckBox Content="Discounts"        IsChecked="{Binding SaleReturnTemplate.TotalsShowDiscounts}"      Margin="0,0,16,6"/>
                                <CheckBox Content="Other expenses"   IsChecked="{Binding SaleReturnTemplate.TotalsShowOtherExpenses}"  Margin="0,0,16,6"/>
                                <CheckBox Content="Grand total"      IsChecked="{Binding SaleReturnTemplate.TotalsShowGrandTotal}"     Margin="0,0,16,6"/>
                                <CheckBox Content="Payment received" IsChecked="{Binding SaleReturnTemplate.TotalsShowPaymentRecv}"    Margin="0,0,16,6"/>
                                <CheckBox Content="Balance"          IsChecked="{Binding SaleReturnTemplate.TotalsShowBalance}"        Margin="0,0,16,6"/>
                            </WrapPanel>

                            <Separator Margin="0,0,0,10"/>
                            <StackPanel Orientation="Vertical" Margin="0,8,0,0">
                                <!-- Top margin -->
                                <DockPanel>
                                    <TextBlock Text="Top margin (lines)" Width="160"/>
                                    <TextBox Width="60" Text="{Binding ActiveTemplate.TopMarginLines, UpdateSourceTrigger=PropertyChanged}"/>
                                </DockPanel>

                                <!-- Business name -->
                                <DockPanel>
                                    <CheckBox Content="Show business name"
IsChecked="{Binding ActiveTemplate.ShowBusinessName}"/>
                                </DockPanel>

                                <DockPanel>
                                    <TextBlock Text="Business font size (pt)" Width="160"/>
                                    <TextBox Width="60" Text="{Binding ActiveTemplate.BusinessNameFontSizePt, UpdateSourceTrigger=PropertyChanged}"/>
                                    <CheckBox Content="Bold" Margin="12,0,0,0"
IsChecked="{Binding ActiveTemplate.BusinessNameBold}"/>
                                </DockPanel>

                                <!-- Address / Contacts -->
                                <DockPanel>
                                    <CheckBox Content="Show address" IsChecked="{Binding ActiveTemplate.ShowAddress}"/>
                                    <CheckBox Content="Show phone" Margin="12,0,0,0" IsChecked="{Binding ActiveTemplate.ShowContacts}"/>
                                </DockPanel>
                            </StackPanel>
                            <Separator Margin="0,0,0,10"/>
                            <TextBlock Text="Common (sales)" FontWeight="SemiBold" Margin="0,0,0,8"/>
                            <StackPanel>
                                <CheckBox Content="Show QR"        IsChecked="{Binding SaleReturnTemplate.ShowQr}"/>
                                <CheckBox Content="Show customer"  IsChecked="{Binding SaleReturnTemplate.ShowCustomerOnReceipt}"/>
                                <CheckBox Content="Show cashier"   IsChecked="{Binding SaleReturnTemplate.ShowCashierOnReceipt}"/>
                                <CheckBox Content="Print barcode"  IsChecked="{Binding SaleReturnTemplate.PrintBarcodeOnReceipt}"/>
                                <CheckBox Content="Show NTN number" IsChecked="{Binding SaleReturnTemplate.ShowNtnOnReceipt}" IsEnabled="{Binding RuntimeHasNtn}"/>
                                <CheckBox Content="Show FBR data (QR &amp; logo)" IsChecked="{Binding SaleReturnTemplate.ShowFbrOnReceipt}" IsEnabled="{Binding RuntimeEnableFbr}"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>
                </TabItem>

                <!-- =================== TAB 3: VOUCHER =================== -->
                <TabItem Header="Voucher">
                    <Border Background="#06000000" BorderBrush="#22000000" BorderThickness="1" CornerRadius="4" Padding="14">
                        <StackPanel>
                            <!-- Mirror bindings to VoucherTemplate -->
                            <TextBlock Text="Printer &amp; paper" FontWeight="SemiBold" Margin="0,0,0,8"/>
                            <Grid Margin="0,0,12,8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="140"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" Text="Printer" VerticalAlignment="Center" Margin="0,0,8,0"/>
                                <TextBlock Grid.Column="1" VerticalAlignment="Center" FontWeight="SemiBold" Text="{Binding InvoicePrinterName}"/>
                            </Grid>
                            <Grid Margin="0,0,0,12">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="140"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" Text="Paper width" VerticalAlignment="Center" Margin="0,0,8,0"/>
                                <ComboBox Grid.Column="1" Width="140" Height="26" VerticalContentAlignment="Center"
                                          SelectedValue="{Binding VoucherTemplate.PaperWidthMm, Mode=TwoWay}"
                                          SelectedValuePath="Tag">
                                    <ComboBoxItem Content="58 mm" Tag="58"/>
                                    <ComboBoxItem Content="80 mm" Tag="80"/>
                                    <i:Interaction.Triggers>
                                        <i:EventTrigger EventName="SelectionChanged">
                                            <i:InvokeCommandAction Command="{Binding PreviewVoucherCommand}"/>
                                        </i:EventTrigger>
                                    </i:Interaction.Triggers>
                                </ComboBox>
                            </Grid>

                            <Separator Margin="0,0,0,10"/>

                            <TextBlock Text="Logo" FontWeight="SemiBold" Margin="0,0,0,8"/>
                            <Grid Margin="0,0,0,12">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <Border Grid.Column="0" BorderBrush="#33000000" BorderThickness="1" CornerRadius="4" Padding="6"
                                        Height="100" Background="#05000000" Margin="0,0,8,0">
                                    <Image Stretch="Uniform"
                                           Source="{Binding IdentityLogoBytes, Converter={StaticResource BytesToBitmap}}"/>
                                </Border>

                                <StackPanel Grid.Column="1" Margin="8,0,0,0">
                                    <CheckBox Content="Show logo" IsChecked="{Binding VoucherTemplate.ShowLogoOnReceipt}"/>
                                    <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                                        <TextBlock Text="Max width (px):" VerticalAlignment="Center"/>
                                        <TextBox Width="90" Height="26" Margin="8,0,0,0" VerticalContentAlignment="Center"
                                                 Text="{Binding VoucherTemplate.LogoMaxWidthPx, UpdateSourceTrigger=PropertyChanged}"/>
                                    </StackPanel>
                                    <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                                        <TextBlock Text="Alignment:" VerticalAlignment="Center"/>
                                        <ComboBox Width="140" Height="26" Margin="8,0,0,0" VerticalContentAlignment="Center"
                                                  SelectedItem="{Binding VoucherTemplate.LogoAlignment, UpdateSourceTrigger=PropertyChanged}">
                                            <ComboBoxItem Content="Left"/>
                                            <ComboBoxItem Content="Center"/>
                                            <ComboBoxItem Content="Right"/>
                                        </ComboBox>
                                    </StackPanel>
                                </StackPanel>
                            </Grid>

                            <Separator Margin="0,0,0,10"/>

                            <TextBlock Text="Row visibility" FontWeight="SemiBold" Margin="0,0,0,8"/>
                            <WrapPanel Margin="0,0,0,12">
                                <CheckBox Content="Product name"  IsChecked="{Binding VoucherTemplate.RowShowProductName}"  Margin="0,0,16,6"/>
                                <CheckBox Content="Product SKU"   IsChecked="{Binding VoucherTemplate.RowShowProductSku}"   Margin="0,0,16,6"/>
                                <CheckBox Content="Quantity"      IsChecked="{Binding VoucherTemplate.RowShowQty}"          Margin="0,0,16,6"/>
                                <CheckBox Content="Unit price"    IsChecked="{Binding VoucherTemplate.RowShowUnitPrice}"    Margin="0,0,16,6"/>
                                <CheckBox Content="Line discount" IsChecked="{Binding VoucherTemplate.RowShowLineDiscount}" Margin="0,0,16,6"/>
                                <CheckBox Content="Line total"    IsChecked="{Binding VoucherTemplate.RowShowLineTotal}"    Margin="0,0,16,6"/>
                            </WrapPanel>

                            <Separator Margin="0,0,0,10"/>

                            <TextBlock Text="Totals" FontWeight="SemiBold" Margin="0,0,0,8"/>
                            <WrapPanel Margin="0,0,0,12">
                                <CheckBox Content="Taxes"          IsChecked="{Binding VoucherTemplate.TotalsShowTaxes}"         Margin="0,0,16,6"/>
                                <CheckBox Content="Discounts"      IsChecked="{Binding VoucherTemplate.TotalsShowDiscounts}"     Margin="0,0,16,6"/>
                                <CheckBox Content="Other expenses" IsChecked="{Binding VoucherTemplate.TotalsShowOtherExpenses}" Margin="0,0,16,6"/>
                                <CheckBox Content="Grand total"    IsChecked="{Binding VoucherTemplate.TotalsShowGrandTotal}"    Margin="0,0,16,6"/>
                            </WrapPanel>

                            <Separator Margin="0,0,0,10"/>
                            <StackPanel Orientation="Vertical" Margin="0,8,0,0">
                                <!-- Top margin -->
                                <DockPanel>
                                    <TextBlock Text="Top margin (lines)" Width="160"/>
                                    <TextBox Width="60" Text="{Binding ActiveTemplate.TopMarginLines, UpdateSourceTrigger=PropertyChanged}"/>
                                </DockPanel>

                                <!-- Business name -->
                                <DockPanel>
                                    <CheckBox Content="Show business name"
IsChecked="{Binding ActiveTemplate.ShowBusinessName}"/>
                                </DockPanel>

                                <DockPanel>
                                    <TextBlock Text="Business font size (pt)" Width="160"/>
                                    <TextBox Width="60" Text="{Binding ActiveTemplate.BusinessNameFontSizePt, UpdateSourceTrigger=PropertyChanged}"/>
                                    <CheckBox Content="Bold" Margin="12,0,0,0"
IsChecked="{Binding ActiveTemplate.BusinessNameBold}"/>
                                </DockPanel>

                                <!-- Address / Contacts -->
                                <DockPanel>
                                    <CheckBox Content="Show address" IsChecked="{Binding ActiveTemplate.ShowAddress}"/>
                                    <CheckBox Content="Show phone" Margin="12,0,0,0" IsChecked="{Binding ActiveTemplate.ShowContacts}"/>
                                </DockPanel>
                            </StackPanel>
                            <Separator Margin="0,0,0,10"/>
                            <TextBlock Text="Common" FontWeight="SemiBold" Margin="0,0,0,8"/>
                            <StackPanel>
                                <CheckBox Content="Show QR"       IsChecked="{Binding VoucherTemplate.ShowQr}"/>
                                <CheckBox Content="Show cashier"  IsChecked="{Binding VoucherTemplate.ShowCashierOnReceipt}"/>
                                <CheckBox Content="Print barcode" IsChecked="{Binding VoucherTemplate.PrintBarcodeOnReceipt}"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>
                </TabItem>

                <!-- =================== TAB 4: Z REPORT =================== -->
                <TabItem Header="Z Report">
                    <Border Background="#06000000" BorderBrush="#22000000" BorderThickness="1" CornerRadius="4" Padding="14">
                        <StackPanel>
                            <TextBlock Text="Printer &amp; paper" FontWeight="SemiBold" Margin="0,0,0,8"/>
                            <Grid Margin="0,0,12,8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="140"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" Text="Printer" VerticalAlignment="Center" Margin="0,0,8,0"/>
                                <TextBlock Grid.Column="1" VerticalAlignment="Center" FontWeight="SemiBold" Text="{Binding InvoicePrinterName}"/>
                            </Grid>
                            <Grid Margin="0,0,0,12">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="140"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" Text="Paper width" VerticalAlignment="Center" Margin="0,0,8,0"/>
                                <ComboBox Grid.Column="1" Width="140" Height="26" VerticalContentAlignment="Center"
                                          SelectedValue="{Binding ZReportTemplate.PaperWidthMm, Mode=TwoWay}"
                                          SelectedValuePath="Tag">
                                    <ComboBoxItem Content="58 mm" Tag="58"/>
                                    <ComboBoxItem Content="80 mm" Tag="80"/>
                                    <i:Interaction.Triggers>
                                        <i:EventTrigger EventName="SelectionChanged">
                                            <i:InvokeCommandAction Command="{Binding PreviewZReportCommand}"/>
                                        </i:EventTrigger>
                                    </i:Interaction.Triggers>
                                </ComboBox>
                            </Grid>

                            <Separator Margin="0,0,0,10"/>

                            <TextBlock Text="Logo" FontWeight="SemiBold" Margin="0,0,0,8"/>
                            <Grid Margin="0,0,0,12">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <Border Grid.Column="0" BorderBrush="#33000000" BorderThickness="1" CornerRadius="4" Padding="6"
                                        Height="100" Background="#05000000" Margin="0,0,8,0">
                                    <Image Stretch="Uniform"
                                           Source="{Binding IdentityLogoBytes, Converter={StaticResource BytesToBitmap}}"/>
                                </Border>

                                <StackPanel Grid.Column="1" Margin="8,0,0,0">
                                    <CheckBox Content="Show logo" IsChecked="{Binding ZReportTemplate.ShowLogoOnReceipt}"/>
                                    <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                                        <TextBlock Text="Max width (px):" VerticalAlignment="Center"/>
                                        <TextBox Width="90" Height="26" Margin="8,0,0,0" VerticalContentAlignment="Center"
                                                 Text="{Binding ZReportTemplate.LogoMaxWidthPx, UpdateSourceTrigger=PropertyChanged}"/>
                                    </StackPanel>
                                    <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                                        <TextBlock Text="Alignment:" VerticalAlignment="Center"/>
                                        <ComboBox Width="140" Height="26" Margin="8,0,0,0" VerticalContentAlignment="Center"
                                                  SelectedItem="{Binding ZReportTemplate.LogoAlignment, UpdateSourceTrigger=PropertyChanged}">
                                            <ComboBoxItem Content="Left"/>
                                            <ComboBoxItem Content="Center"/>
                                            <ComboBoxItem Content="Right"/>
                                        </ComboBox>
                                    </StackPanel>
                                </StackPanel>
                            </Grid>

                            <Separator Margin="0,0,0,10"/>
                            <StackPanel Orientation="Vertical" Margin="0,8,0,0">
                                <!-- Top margin -->
                                <DockPanel>
                                    <TextBlock Text="Top margin (lines)" Width="160"/>
                                    <TextBox Width="60" Text="{Binding ActiveTemplate.TopMarginLines, UpdateSourceTrigger=PropertyChanged}"/>
                                </DockPanel>

                                <!-- Business name -->
                                <DockPanel>
                                    <CheckBox Content="Show business name" IsChecked="{Binding ActiveTemplate.ShowBusinessName}"/>
                                </DockPanel>

                                <DockPanel>
                                    <TextBlock Text="Business font size (pt)" Width="160"/>
                                    <TextBox Width="60" Text="{Binding ActiveTemplate.BusinessNameFontSizePt, UpdateSourceTrigger=PropertyChanged}"/>
                                    <CheckBox Content="Bold" Margin="12,0,0,0"
IsChecked="{Binding ActiveTemplate.BusinessNameBold}"/>
                                </DockPanel>

                                <!-- Address / Contacts -->
                                <DockPanel>
                                    <CheckBox Content="Show address" IsChecked="{Binding ActiveTemplate.ShowAddress}"/>
                                    <CheckBox Content="Show phone" Margin="12,0,0,0" IsChecked="{Binding ActiveTemplate.ShowContacts}"/>
                                </DockPanel>
                            </StackPanel>
                            <Separator Margin="0,0,0,10"/>
                            <TextBlock Text="Common (Z Report)" FontWeight="SemiBold" Margin="0,0,0,8"/>
                            <StackPanel>
                                <CheckBox Content="Show QR"       IsChecked="{Binding ZReportTemplate.ShowQr}"/>
                                <CheckBox Content="Show cashier"  IsChecked="{Binding ZReportTemplate.ShowCashierOnReceipt}"/>
                                <CheckBox Content="Print barcode" IsChecked="{Binding ZReportTemplate.PrintBarcodeOnReceipt}"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>
                </TabItem>
            </TabControl>

            <!-- RIGHT: ONE PREVIEW ONLY -->
            <Border Grid.Column="1"
                    Background="#06000000"
                    BorderBrush="#22000000"
                    BorderThickness="1"
                    CornerRadius="4"
                    Padding="4" Margin="0,24,0,0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition/>
                    </Grid.RowDefinitions>

                    <TextBlock Text="Receipt preview" FontWeight="SemiBold" Margin="0,0,0,8"/>

                    <!-- Single shared preview: binds to PreviewBitmap -->
                    <ScrollViewer Grid.Row="1"
                                  Margin="0,4,0,0"
                                  Padding="0"
                                  HorizontalScrollBarVisibility="Disabled"
                                  VerticalScrollBarVisibility="Auto">
                        <Grid>
                            <!-- Uniform keeps the proportions correct; it will fit to the available width -->
                            <Image Source="{Binding PreviewBitmap}"
                                   Stretch="Uniform"
                                   SnapsToDevicePixels="True"
                                   UseLayoutRounding="True"
                                   HorizontalAlignment="Center"/>
                        </Grid>
                    </ScrollViewer>
                </Grid>
            </Border>
        </Grid>

        <!-- ACTIONS -->
        <DockPanel Grid.Row="3" Margin="0,16,0,0">
            <TextBlock DockPanel.Dock="Left"
                       VerticalAlignment="Center"
                       FontSize="11"
                       Foreground="{DynamicResource {x:Static SystemColors.GrayTextBrushKey}}"
                       Text="Printer and footer come from Invoice Settings. Layout is saved per outlet (or globally)."/>
            <StackPanel DockPanel.Dock="Right" Orientation="Horizontal">
                <Button Content="Save All" Height="26" MinWidth="100"
                        Command="{Binding SaveAllCommand}" Margin="0,0,8,0"/>
                <Button Content="Print Test (Current Tab)" Height="26" MinWidth="150"
                        Command="{Binding PrintCurrentCommand}"/>
            </StackPanel>
        </DockPanel>
    </Grid>
</UserControl>

<Window x:Class="Pos.Client.Wpf.Windows.Accounting.VoucherEditorWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:Local="clr-namespace:Pos.Client.Wpf.Converters"
        xmlns:ctrl="clr-namespace:Pos.Client.Wpf.Controls"
        Title="Voucher Editor" Height="560" Width="900"
        WindowStartupLocation="CenterOwner">
    <DockPanel Margin="12">
        <!-- Top bar -->
        <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Margin="0,0,0,8" VerticalAlignment="Center">
            <TextBlock Text="Type:" VerticalAlignment="Center"/>
            <ComboBox Width="130" Margin="6,0"
            ItemsSource="{Binding VoucherTypes}"
            SelectedItem="{Binding Type}"
            IsEnabled="{Binding IsTypeChangeAllowed}"/>

            <TextBlock Text="Date:" Margin="16,0,0,0" VerticalAlignment="Center"/>
            <DatePicker Margin="6,0" SelectedDate="{Binding VoucherDate}" />

            <TextBlock Text="Outlet:" Margin="16,0,0,0" VerticalAlignment="Center"/>
            <ComboBox Width="200" Margin="6,0"
            ItemsSource="{Binding Outlets}"
            SelectedItem="{Binding SelectedOutlet}"
            DisplayMemberPath="Name"
            IsEnabled="{Binding IsOutletSelectable}"/>

            <TextBlock Text="Ref No:" Margin="16,0,0,0" VerticalAlignment="Center"/>
            <TextBox Width="160" Margin="6,0" Text="{Binding RefNo}"/>

            <Button Content="Save &amp; Post" Margin="16,0,0,0" Command="{Binding SaveCmd}"
          IsEnabled="{Binding SaveEnabled}"/>
        </StackPanel>


        <!-- Lines grid -->
        <DataGrid ItemsSource="{Binding Lines}" Style="{StaticResource ModernDataGrid}"
          SelectedItem="{Binding SelectedLine}"
          AutoGenerateColumns="False"
          CanUserAddRows="True"
          HeadersVisibility="Column"
          Margin="0,6,0,0"
          IsReadOnly="False">
            <DataGrid.Columns>

                <!-- Delete button column -->
                <DataGridTemplateColumn Width="42">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <Button Content="✕"
                  ToolTip="Delete row"
                  Padding="0"
                  Width="28" Height="26"
                  Command="{Binding DataContext.DeleteLineCmd, RelativeSource={RelativeSource AncestorType=Window}}"
                  CommandParameter="{Binding}"/>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>

                <!-- Account search box -->
                <DataGridTemplateColumn Header="Account" Width="*">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding Account.Name}"/>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                    <DataGridTemplateColumn.CellEditingTemplate>
                        <DataTemplate>
                            <ctrl:AccountSearchBox SelectedAccount="{Binding Account, Mode=TwoWay}"/>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellEditingTemplate>
                </DataGridTemplateColumn>

                <!-- Description -->
                <DataGridTextColumn Header="Description"
                        Binding="{Binding Description, UpdateSourceTrigger=PropertyChanged}"
                        Width="2*"/>

                <!-- Debit -->
                <DataGridTemplateColumn Header="Debit" Width="120">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding Debit, StringFormat=N2}">
                                <TextBlock.Visibility>
                                    <Binding Path="DataContext.ShowDebitColumn" RelativeSource="{RelativeSource AncestorType=Window}">
                                        <Binding.Converter>
                                            <BooleanToVisibilityConverter/>
                                        </Binding.Converter>
                                    </Binding>
                                </TextBlock.Visibility>
                            </TextBlock>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                    <DataGridTemplateColumn.CellEditingTemplate>
                        <DataTemplate>
                            <TextBox Text="{Binding Debit, UpdateSourceTrigger=PropertyChanged}">
                                <TextBox.Visibility>
                                    <Binding Path="DataContext.ShowDebitColumn" RelativeSource="{RelativeSource AncestorType=Window}">
                                        <Binding.Converter>
                                            <BooleanToVisibilityConverter/>
                                        </Binding.Converter>
                                    </Binding>
                                </TextBox.Visibility>
                            </TextBox>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellEditingTemplate>
                </DataGridTemplateColumn>

                <!-- Credit -->
                <DataGridTemplateColumn Header="Credit" Width="120">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding Credit, StringFormat=N2}">
                                <TextBlock.Visibility>
                                    <Binding Path="DataContext.ShowCreditColumn" RelativeSource="{RelativeSource AncestorType=Window}">
                                        <Binding.Converter>
                                            <BooleanToVisibilityConverter/>
                                        </Binding.Converter>
                                    </Binding>
                                </TextBlock.Visibility>
                            </TextBlock>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                    <DataGridTemplateColumn.CellEditingTemplate>
                        <DataTemplate>
                            <TextBox Text="{Binding Credit, UpdateSourceTrigger=PropertyChanged}">
                                <TextBox.Visibility>
                                    <Binding Path="DataContext.ShowCreditColumn" RelativeSource="{RelativeSource AncestorType=Window}">
                                        <Binding.Converter>
                                            <BooleanToVisibilityConverter/>
                                        </Binding.Converter>
                                    </Binding>
                                </TextBox.Visibility>
                            </TextBox>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellEditingTemplate>
                </DataGridTemplateColumn>

            </DataGrid.Columns>
        </DataGrid>

        <!-- Totals bar -->
        <StackPanel DockPanel.Dock="Bottom" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,8,0,0">
            <TextBlock Text="Debits:" VerticalAlignment="Center"/>
            <TextBlock Text="{Binding TotalDebit, StringFormat=N2}" Margin="6,0,16,0" FontWeight="Bold"/>
            <TextBlock Text="Credits:" VerticalAlignment="Center"/>
            <TextBlock Text="{Binding TotalCredit, StringFormat=N2}" Margin="6,0,16,0" FontWeight="Bold"/>

            <!-- Optional: difference display for Journal -->
            <TextBlock Text="Diff:" VerticalAlignment="Center" Margin="6,0,0,0"/>
            <TextBlock Margin="6,0,16,0" FontWeight="Bold">
                <TextBlock.Text>
                    <MultiBinding StringFormat="{}{0:N2}">
                        <Binding Path="TotalDebit"/>
                        <Binding Path="TotalCredit"/>
                        <MultiBinding.Converter>
                            <Local:SubtractConverter/>
                            <!-- see note below -->
                        </MultiBinding.Converter>
                    </MultiBinding>
                </TextBlock.Text>
                <TextBlock.Visibility>
                    <Binding Path="Type">
                        <Binding.Converter>
                            <Local:JournalDiffVisibilityConverter/>
                            <!-- see note below -->
                        </Binding.Converter>
                    </Binding>
                </TextBlock.Visibility>
            </TextBlock>

            <TextBlock Text="Memo:" VerticalAlignment="Center"/>
            <TextBox Width="260" Margin="6,0" Text="{Binding Memo}"/>
        </StackPanel>
    </DockPanel>

</Window>

<!-- Pos.Client.Wpf/Windows/Purchases/PurchaseWindow.xaml -->
<UserControl x:Class="Pos.Client.Wpf.Windows.Purchases.PurchaseView"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:Controls="clr-namespace:Pos.Client.Wpf.Controls"
        mc:Ignorable="d"
        Loaded="UserControl_Loaded">


    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <!-- TOP TOOLBAR -->
            <RowDefinition Height="*"/>
            <!-- CONTENT -->
        </Grid.RowDefinitions>
        <ToolBarTray Grid.Row="0">
            <ToolBar>
                <!-- New / Clear -->
                <Button Click="ClearButton_Click" ToolTip="New (F5)">
                    <StackPanel Orientation="Horizontal" Margin="4,0">
                        <TextBlock Text="New" Margin="2,0"/>
                        <TextBlock Text="(F5)" Opacity="0.6" Margin="6,0,0,0"/>
                    </StackPanel>
                </Button>

                <!-- Hold / Save Draft -->
                <Button Click="HoldButton_Click" ToolTip="Hold Invoice (F8)">
                    <StackPanel Orientation="Horizontal" Margin="4,0">
                        <TextBlock Text="Hold Invoice" Margin="2,0"/>
                        <TextBlock Text="(F8)" Opacity="0.6" Margin="6,0,0,0"/>
                    </StackPanel>
                </Button>

                <!-- Post / Receive -->
                <Button Click="PostReceive_Click" ToolTip="Post / Receive (F9)">
                    <StackPanel Orientation="Horizontal" Margin="4,0">
                        <TextBlock Text="Post / Receive" Margin="2,0"/>
                        <TextBlock Text="(F9)" Opacity="0.6" Margin="6,0,0,0"/>
                    </StackPanel>
                </Button>
                <Separator/>

                <Button Click="SaveDraft_Click" ToolTip="Save / Draft (F10)">
                    <StackPanel Orientation="Horizontal" Margin="4,0">
                        <TextBlock Text="Save Draft" Margin="2,0"/>
                        <TextBlock Text="(F10)" Opacity="0.6" Margin="6,0,0,0"/>
                    </StackPanel>
                </Button>

                <Button x:Name="BtnSaveAmend" Click="SaveDraft_Click" ToolTip="Save Amendment (F11)" Visibility="Collapsed" >
                    <StackPanel Orientation="Horizontal" Margin="4,0">
                        <TextBlock Text="Save Amendment" Margin="2,0"/>
                        <TextBlock Text="(F11)" Opacity="0.6" Margin="6,0,0,0"/>
                    </StackPanel>
                </Button>

                <!-- (Optional) Pick Held drafts list if you have a dialog -->

            </ToolBar>
        </ToolBarTray>


        <Grid Grid.Row="1" Margin="16">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <!-- Scan/Search -->
                <RowDefinition Height="*"/>
                <!-- Lines grid -->
                <RowDefinition Height="Auto"/>
                <!-- Totals + destination + actions + payments -->
                <!--<RowDefinition Height="Auto"/>-->

            </Grid.RowDefinitions>
            <StackPanel Grid.Row="0" Margin="0,0,0,0">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <StackPanel Grid.Column="0">
                        <!-- ======================= Header ======================= -->
                        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,12" VerticalAlignment="Top">
                            <!-- Supplier -->
                            <StackPanel Margin="0,0,12,0">
                                <TextBlock Text="Supplier" FontWeight="SemiBold"/>
                                <!-- NEW: universal party search in Supplier mode -->
                                <Controls:CustomerSearchBox
                                    x:Name="SupplierSearch"
                                    Width="260"
                                    Mode="Suppliers"
                                    CustomerPicked="SupplierSearch_CustomerPicked" />
                            </StackPanel>


                            <StackPanel Margin="0,0,12,0">
                                <TextBlock Text="Vendor Invoice #" FontWeight="SemiBold"/>
                                <TextBox x:Name="VendorInvBox" Width="160" Height="28" IsTabStop="True"
         Focusable="True"
    KeyDown="VendorInvBox_KeyDown" />
                                <!-- NEW -->

                            </StackPanel>

                            <StackPanel>
                                <TextBlock Text="Date" FontWeight="SemiBold"/>
                                <DatePicker x:Name="DatePicker" Height="28"
   KeyDown="DatePicker_KeyDown" />
                                <!-- NEW -->
                            </StackPanel>

                            <!-- Optional: simple draft toggle -->

                        </StackPanel>

                        <!-- =================== Scan / Search row =================== -->
                        <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,0,0,8">
                            <TextBlock Text="Search Item:" VerticalAlignment="Center" Margin="0,0,6,0"/>
                            <Controls:ItemSearchBox x:Name="ItemSearch" ItemPicked="ItemSearch_ItemPicked" Width="360" Margin="0,0,8,0"/>
                            <!-- keep your Add/Receive/etc. buttons as they were -->
                        </StackPanel>

                    </StackPanel>
                    <StackPanel Grid.Column="1" VerticalAlignment="Bottom" HorizontalAlignment="Right">

                        <GroupBox Grid.Column="0" Header="Destination" Padding="8" Margin="12,0,0,8">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="200"/>
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                <!-- Outlet row -->
                                <RadioButton x:Name="DestOutletRadio" Grid.Row="0" Grid.Column="0" Content="Outlet" VerticalAlignment="Center" Checked="DestRadio_Checked" Margin="0,0,8,0"/>
                                <ComboBox x:Name="OutletBox" Grid.Row="0" Grid.Column="1" Width="180" DisplayMemberPath="Name" SelectedValuePath="Id" IsEditable="False" ToolTip="Pick outlet when stock goes directly to an outlet"/>

                                <!-- Warehouse row -->
                                <RadioButton x:Name="DestWarehouseRadio" Grid.Row="1" Grid.Column="0" Content="Warehouse" VerticalAlignment="Center" Checked="DestRadio_Checked" Margin="0,0,8,4"/>
                                <ComboBox x:Name="WarehouseBox" Grid.Row="1" Grid.Column="1" Width="180" DisplayMemberPath="Name" SelectedValuePath="Id" IsEditable="False" ToolTip="Pick warehouse when stock goes to central warehouse"/>
                            </Grid>
                        </GroupBox>





                    </StackPanel>

                </Grid>


            </StackPanel>


            <!-- ======================= Lines grid ======================= -->
            <DataGrid x:Name="LinesGrid" Grid.Row="1" FontSize="16" FontWeight="DemiBold" Style="{StaticResource ModernDataGrid}"
          AutoGenerateColumns="False"
          CanUserAddRows="False"
          CanUserDeleteRows="False"
          SelectionMode="Extended"
          SelectionUnit="FullRow"
          Margin="0,0,0,4">

                <DataGrid.ContextMenu>
                    <ContextMenu>
                        <MenuItem Header="Delete selected row(s)" Click="DeleteSelectedMenu_Click"/>
                    </ContextMenu>
                </DataGrid.ContextMenu>


                <DataGrid.Columns>

                    <!-- 🗑 Delete button column must be INSIDE Columns -->
                    <DataGridTemplateColumn Width="40" IsReadOnly="True">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Button Padding="0" Margin="0"
                  Content="🗑"
                  ToolTip="Delete this line"
                  Click="DeleteLineButton_Click"
                  Tag="{Binding}" />
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                    <!-- Identifiers -->
                    <DataGridTextColumn Header="SKU"  Binding="{Binding Sku}"  Width="120" IsReadOnly="True"/>
                    <DataGridTextColumn Header="Item" Binding="{Binding Name}" Width="2*"  IsReadOnly="True"/>

                    <!-- Qty -->
                    <DataGridTextColumn Header="Qty" Width="80"
                        Binding="{Binding Qty, UpdateSourceTrigger=PropertyChanged, StringFormat=N3}">
                        <DataGridTextColumn.EditingElementStyle>
                            <Style TargetType="TextBox">
                                <Setter Property="HorizontalContentAlignment" Value="Right"/>
                                <EventSetter Event="PreviewTextInput" Handler="Numeric_PreviewTextInput"/>
                            </Style>
                        </DataGridTextColumn.EditingElementStyle>
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock">
                                <Setter Property="TextAlignment" Value="Right"/>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>

                    <!-- Price -->
                    <DataGridTextColumn Header="Price" Width="100"
                        Binding="{Binding UnitCost, UpdateSourceTrigger=PropertyChanged, StringFormat=N2}">
                        <DataGridTextColumn.EditingElementStyle>
                            <Style TargetType="TextBox">
                                <Setter Property="HorizontalContentAlignment" Value="Right"/>
                                <EventSetter Event="PreviewTextInput" Handler="Numeric_PreviewTextInput"/>
                            </Style>
                        </DataGridTextColumn.EditingElementStyle>
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock">
                                <Setter Property="TextAlignment" Value="Right"/>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>

                    <!-- Discount (amount) -->
                    <DataGridTextColumn Header="Disc" Width="90"
                        Binding="{Binding Discount, UpdateSourceTrigger=PropertyChanged, StringFormat=N2}">
                        <DataGridTextColumn.EditingElementStyle>
                            <Style TargetType="TextBox">
                                <Setter Property="HorizontalContentAlignment" Value="Right"/>
                                <EventSetter Event="PreviewTextInput" Handler="Numeric_PreviewTextInput"/>
                            </Style>
                        </DataGridTextColumn.EditingElementStyle>
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock">
                                <Setter Property="TextAlignment" Value="Right"/>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>

                    <!-- Tax % -->
                    <DataGridTextColumn Header="Tax %" Width="80"
                        Binding="{Binding TaxRate, UpdateSourceTrigger=PropertyChanged, StringFormat=N2}">
                        <DataGridTextColumn.EditingElementStyle>
                            <Style TargetType="TextBox">
                                <Setter Property="HorizontalContentAlignment" Value="Right"/>
                                <EventSetter Event="PreviewTextInput" Handler="Numeric_PreviewTextInput"/>
                            </Style>
                        </DataGridTextColumn.EditingElementStyle>
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock">
                                <Setter Property="TextAlignment" Value="Right"/>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>

                    <!-- Computed -->
                    <DataGridTextColumn Header="Line Total" Width="110" IsReadOnly="True"
                        Binding="{Binding LineTotal, Mode=OneWay, StringFormat=N2}">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock">
                                <Setter Property="TextAlignment" Value="Right"/>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>

                    <DataGridTextColumn Header="Notes" Binding="{Binding Notes}" Width="*"/>

                </DataGrid.Columns>
            </DataGrid>


            <!-- =================== Bottom: Destination + Totals + Actions + Payments =================== -->
            <Border Grid.Row="2" Margin="0,0,0,0" Padding="12" BorderBrush="#DDD" BorderThickness="1" CornerRadius="8" Background="#FAFAFA">
                <Grid>
                    <!-- Row 0: content | Row 1: buttons -->
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <!-- ===== Row 0: CONTENT (3 columns) ===== -->
                    <Grid Grid.Column="0">
                        <StackPanel Grid.Column="1" Margin="0,0,0,0" VerticalAlignment="Bottom">
                            <GroupBox Header="Payments">
                                <StackPanel>
                                    <!-- Advance row -->
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="Advance:" Margin="0,0,6,0"/>
                                        <TextBox x:Name="AdvanceAmtBox" Width="80"/>

                                        <!-- Methods: ONLY Cash + Bank -->
                                        <ComboBox x:Name="AdvanceMethodBox"
                      Width="100"
                      Margin="6,0,0,0"
                      SelectedIndex="0"
                      SelectionChanged="AdvanceMethodBox_SelectionChanged">
                                            <ComboBoxItem x:Name="AdvanceMethodCashItem" Content="Cash"/>
                                            <ComboBoxItem x:Name="AdvanceMethodBankItem" Content="Bank"/>
                                        </ComboBox>

                                        <!-- Bank picker: visible only when Method==Bank -->
                                        <StackPanel x:Name="BankPickerPanel"
                        Orientation="Horizontal"
                        Margin="8,0,0,0"
                        Visibility="Collapsed">
                                            <TextBlock Text="Bank:" VerticalAlignment="Center" Margin="0,0,6,0"/>
                                            <ComboBox x:Name="BankAccountBox"
                          Width="260"
                          DisplayMemberPath="Name"
                          SelectedValuePath="Id"/>
                                        </StackPanel>

                                        <Button Content="Add Advance"
                    Margin="6,0,0,0"
                    Width="100"
                    Click="BtnAddAdvance_Click"/>
                                    </StackPanel>

                                    <!-- keep the payments grid unchanged -->
                                    <DataGrid x:Name="PaymentsGrid"
                                          AutoGenerateColumns="False"
                                          CanUserAddRows="False"
                                          CanUserDeleteRows="False"
                                          IsReadOnly="False"
                                          ItemsSource="{Binding Payments}"  
                                          RowEditEnding="PaymentsGrid_RowEditEnding"
                                          SelectionMode="Single"
                                          SelectionUnit="FullRow" Height="95">

                                        <DataGrid.Columns>
                                            <DataGridTextColumn Header="Method"
                                                Binding="{Binding Method}"
                                                IsReadOnly="True"
                                                Width="120"/>


                                            <!-- Amount -->
                                            <DataGridTextColumn Header="Amount"
                            Binding="{Binding Amount, UpdateSourceTrigger=PropertyChanged, StringFormat=N2}"
                            IsReadOnly="{Binding Id, Converter={StaticResource PersistedToReadOnlyConverter}}"/>

                                            <!-- Note -->
                                            <DataGridTextColumn Header="Note" 
                            Binding="{Binding Note, UpdateSourceTrigger=PropertyChanged}"
                            IsReadOnly="{Binding Id, Converter={StaticResource PersistedToReadOnlyConverter}}"/>

                                            <!-- Delete button -->
                                            <DataGridTemplateColumn Header="">
                                                <DataGridTemplateColumn.CellTemplate>
                                                    <DataTemplate>
                                                        <Button Content="Delete"
                            Padding="6,2"
                            Click="BtnDeletePayment_Click"
                            Tag="{Binding}"
                            ToolTip="Delete payment (staged rows delete locally; saved rows delete from DB)"/>
                                                    </DataTemplate>
                                                </DataGridTemplateColumn.CellTemplate>
                                            </DataGridTemplateColumn>
                                        </DataGrid.Columns>

                                        <!-- Optional context menu -->
                                        <DataGrid.ContextMenu>
                                            <ContextMenu>
                                                <MenuItem Header="Delete" Click="BtnDeletePayment_Click" CommandParameter="{Binding PlacementTarget.SelectedItem, RelativeSource={RelativeSource AncestorType=ContextMenu}}"/>
                                            </ContextMenu>
                                        </DataGrid.ContextMenu>
                                    </DataGrid>

                                </StackPanel>
                            </GroupBox>

                        </StackPanel>
                    </Grid>

                    <Grid  Grid.Column="1" Margin="0,2,0,0">
                        <GroupBox Header="Totals" FontSize="16" Padding="8" Margin="0,0,0,8" HorizontalAlignment="Right" Width="430">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="*"/>
                                    <RowDefinition Height="*"/>
                                    <RowDefinition Height="*"/>
                                </Grid.RowDefinitions>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <!-- Row 0 -->
                                <TextBlock Grid.Row="0" Grid.Column="0" Text="Subtotal:" FontWeight="SemiBold" Margin="0,0,8,0"/>
                                <TextBlock Grid.Row="0" Grid.Column="1" x:Name="SubtotalText"/>
                                <TextBlock Grid.Row="0" Grid.Column="2" Text="Discount:" FontWeight="SemiBold" Margin="12,0,8,0"/>
                                <TextBlock Grid.Row="0" Grid.Column="3" x:Name="DiscountText"/>
                                <!-- Row 1 -->
                                <TextBlock Grid.Row="1" Grid.Column="0" Text="Tax:" FontWeight="SemiBold" Margin="0,0,8,0"/>
                                <TextBlock Grid.Row="1" Grid.Column="1" x:Name="TaxText"/>
                                <TextBlock Grid.Row="1" Grid.Column="2" Text="Other:" FontWeight="SemiBold" Margin="12,0,8,0"/>
                                <TextBox Grid.Row="1" Grid.Column="3" x:Name="OtherChargesBox" TextChanged="OtherChargesBox_TextChanged" Margin="0,0,0,16"/>
                                <!-- Row 2 -->
                                <TextBlock Grid.Row="2" Grid.Column="0" Text="Grand Total:" FontWeight="Bold" Margin="0,0,8,0"/>
                                <TextBlock Grid.Row="2" Grid.Column="1" x:Name="GrandTotalText" FontWeight="Bold"/>
                            </Grid>
                        </GroupBox>
                    </Grid>

                </Grid>
            </Border>

        </Grid>
    </Grid>

</UserControl>

<Window x:Class="Pos.Client.Wpf.Windows.Purchases.PurchaseReturnWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:Controls="clr-namespace:Pos.Client.Wpf.Controls"
        mc:Ignorable="d"
        Title="Purchase Return" Height="720" Width="1100"
        WindowStartupLocation="CenterOwner"
        ResizeMode="CanResize">
    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
       
        <Style TargetType="TextBlock">
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
        <Style TargetType="TextBox">
            <Setter Property="VerticalContentAlignment" Value="Center"/>
        </Style>
        <Style TargetType="DataGrid">
            <Setter Property="AutoGenerateColumns" Value="False"/>
            <Setter Property="CanUserAddRows" Value="False"/>
            <Setter Property="CanUserDeleteRows" Value="False"/>
            <Setter Property="IsReadOnly" Value="False"/>
        </Style>
    </Window.Resources>

    <Grid Margin="16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <!-- NEW: Toolbar -->
            <RowDefinition Height="Auto"/>
            <!-- Header -->
            <RowDefinition Height="Auto"/>
            <!-- Item Search -->
            <RowDefinition Height="*"/>
            <!-- Lines -->
            <RowDefinition Height="Auto"/>
            <!-- Totals -->
        </Grid.RowDefinitions>

        <ToolBar Grid.Row="0" Padding="6" Background="#F7F7F7">
            <Button Content="Cancel"
          Width="110"
          Margin="0,0,6,0"
          Click="BtnCancel_Click" />

            <Separator/>

            <Button Content="Save Return"
          Width="150"
          Click="BtnSave_Click"
          ToolTip="Save this purchase return (Ctrl+S)"/>
        </ToolBar>

        
        <!-- ===== HEADER ===== -->
        <Border Grid.Row="1" Padding="12" BorderBrush="#DDD" BorderThickness="1" CornerRadius="8">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="2*"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- Supplier (editable only for Return-Without) -->
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="Supplier:" FontWeight="SemiBold" Margin="0,0,6,0"/>

                    <Grid>
                        <TextBox x:Name="SupplierText" Width="260" Height="28"
                             IsReadOnly="{Binding IsSupplierReadonly}"
                             Text="{Binding SupplierDisplay, UpdateSourceTrigger=PropertyChanged}"
                             TextChanged="SupplierText_TextChanged"
                             PreviewKeyDown="SupplierText_PreviewKeyDown"
                             LostKeyboardFocus="SupplierText_LostKeyboardFocus"/>

                        <!-- Autocomplete popup -->
                        <Popup x:Name="SupplierPopup"
                           Placement="Bottom"
                           PlacementTarget="{Binding ElementName=SupplierText}"
                           StaysOpen="False"
                           AllowsTransparency="True"
                           Focusable="False">
                            <Border Background="White" BorderBrush="#DDD" BorderThickness="1" CornerRadius="6" Padding="4" Width="{Binding ElementName=SupplierText, Path=ActualWidth}">
                                <ScrollViewer VerticalScrollBarVisibility="Auto" MaxHeight="220">
                                    <ListBox x:Name="SupplierList" MouseDoubleClick="SupplierList_MouseDoubleClick" PreviewKeyDown="SupplierList_PreviewKeyDown" IsTextSearchEnabled="False">
                                        <ListBox.ItemTemplate>
                                            <DataTemplate>
                                                <StackPanel Orientation="Vertical" Margin="4,3">
                                                    <TextBlock Text="{Binding Name}" FontWeight="SemiBold"/>
                                                    <TextBlock Text="{Binding Phone}" Foreground="#777" FontSize="12"/>
                                                </StackPanel>
                                            </DataTemplate>
                                        </ListBox.ItemTemplate>
                                    </ListBox>
                                </ScrollViewer>
                            </Border>
                        </Popup>
                    </Grid>

                    
                </StackPanel>


                <!-- Target (Outlet / Warehouse) -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Left">
                    <TextBlock Text="Target:" FontWeight="SemiBold" Margin="0,0,6,0"/>
                    <TextBlock Text="{Binding TargetDisplay}"/>
                </StackPanel>

                <!-- Base document -->
                <StackPanel Grid.Column="2" Orientation="Horizontal" HorizontalAlignment="Left">
                    <TextBlock Text="Base Purchase:" FontWeight="SemiBold" Margin="0,0,6,0"/>
                    <TextBlock Text="{Binding BasePurchaseDisplay}"/>
                </StackPanel>

                <!-- Return No + Date -->
                <StackPanel Grid.Column="3" Orientation="Horizontal" HorizontalAlignment="Right">
                    <TextBlock Text="Return No:" FontWeight="SemiBold" Margin="0,0,6,0"/>
                    <TextBlock Text="{Binding ReturnNoDisplay}"/>
                    <TextBlock Text=" | " Foreground="#AAA" Margin="6,0"/>
                    <TextBlock Text="{Binding DateDisplay}"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- ===== ITEM SEARCH (free-form only) ===== -->
        <StackPanel Grid.Row="2" Orientation="Horizontal" Margin="0,12,0,12" HorizontalAlignment="Left"
            Visibility="{Binding CanAddItems, Converter={StaticResource BoolToVis}}">
            <TextBlock Text="Item Search:" FontWeight="SemiBold" Margin="0,0,6,0"/>
            <!-- New shared search control -->
            <Controls:ItemSearchBox x:Name="ItemSearch"
                        Margin="0,4,0,8"
                        ItemPicked="ItemSearch_ItemPicked"
                        TabIndex="30" />

            <!--<Grid>
                <TextBox x:Name="ItemText" Width="360" Height="32"
                     TextChanged="ItemText_TextChanged"
                     PreviewKeyDown="ItemText_PreviewKeyDown"
                     LostKeyboardFocus="ItemText_LostKeyboardFocus"/>

                <Popup x:Name="ItemPopup"
                   Placement="Bottom"
                   PlacementTarget="{Binding ElementName=ItemText}"
                   StaysOpen="False"
                   AllowsTransparency="True"
                   Focusable="False">
                    <Border Background="White" BorderBrush="#DDD" BorderThickness="1" CornerRadius="6" Padding="4"
              Width="{Binding ElementName=ItemText, Path=ActualWidth}">
                        <ScrollViewer VerticalScrollBarVisibility="Auto" MaxHeight="260">
                            <ListBox x:Name="ItemList"
                   MouseDoubleClick="ItemList_MouseDoubleClick"
                   PreviewKeyDown="ItemList_PreviewKeyDown"
                   IsTextSearchEnabled="False">
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <StackPanel Margin="4,3">
                                            <TextBlock Text="{Binding Display}" FontWeight="SemiBold"/>
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock Text="{Binding Sku}" Foreground="#777" FontSize="12"/>
                                                <TextBlock Text="{Binding LastCostDisplay}" Foreground="#777" FontSize="12"/>
                                            </StackPanel>
                                        </StackPanel>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>
                        </ScrollViewer>
                    </Border>
                </Popup>
            </Grid>-->

            <!-- Return Source: only visible for WITHOUT-INVOICE returns --><!--
            <StackPanel Orientation="Horizontal" Grid.ColumnSpan="2" Margin="0,6,0,0">
                --><!-- On-hand label --><!--
                <Border Margin="8,0,0,0" Padding="6,2" Background="#FFF9F9F9" BorderBrush="#FFDDDDDD" BorderThickness="1" CornerRadius="4">
                    <TextBlock>
                        <Run Text="On hand: "/>
                        <Run Text="{Binding CurrentItemOnHandQty, StringFormat={}{0:0.##}}"/>
                    </TextBlock>
                </Border>
            </StackPanel>-->
            <!-- Return Source: only visible for WITHOUT-INVOICE returns -->
            <StackPanel Orientation="Horizontal" Margin="8,0,0,0"
            Visibility="{Binding IsWithoutInvoice, Converter={StaticResource BoolToVis}}">
                <TextBlock Text="Source:" VerticalAlignment="Center" Margin="0,0,16,0"/>

                <!-- Radios -->
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <RadioButton Content="Outlet"
                     IsChecked="{Binding IsOutletSelected, Mode=TwoWay}"
                     Margin="0,0,8,0"
                     IsEnabled="{Binding IsSourceEditable}" />
                    <RadioButton Content="Warehouse"
                     IsChecked="{Binding IsWarehouseSelected, Mode=TwoWay}"
                     IsEnabled="{Binding IsSourceEditable}" />
                </StackPanel>

                <!-- Outlet picker -->
                <ComboBox Width="220" Margin="10,0,0,0"
              ItemsSource="{Binding OutletList}"
              DisplayMemberPath="Name"
              SelectedValuePath="Id"
              SelectedValue="{Binding OutletId, Mode=TwoWay}"
              Visibility="{Binding ShowOutletPicker, Converter={StaticResource BoolToVis}}"
              IsEnabled="{Binding IsSourceEditable}" />

                <!-- Warehouse picker -->
                <ComboBox Width="220" Margin="10,0,0,0"
              ItemsSource="{Binding WarehouseList}"
              DisplayMemberPath="Name"
              SelectedValuePath="Id"
              SelectedValue="{Binding WarehouseId, Mode=TwoWay}"
              Visibility="{Binding ShowWarehousePicker, Converter={StaticResource BoolToVis}}"
              IsEnabled="{Binding IsSourceEditable}" />
            </StackPanel>

            <!-- ===== ITEM SEARCH (free-form only) ===== -->
            <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,0,0,0" HorizontalAlignment="Left"
            Visibility="{Binding CanAddItems, Converter={StaticResource BoolToVis}}">
                <!-- Existing "On hand" chip you already have -->
                <StackPanel Orientation="Horizontal" Grid.ColumnSpan="2" Margin="0,6,0,0">
                    <!-- NEW: Available chip (auto show/hide like in Stock Transfer) -->
                    <Border x:Name="AvailablePanel"
        Margin="8,0,0,0"
        Padding="6,2"
        Background="#FFF9F9F9"
        BorderBrush="#FFDDDDDD"
        BorderThickness="1"
        CornerRadius="4"
        Visibility="Collapsed"
        VerticalAlignment="Center"
        ToolTip="On-hand at the selected source for the current line item.">
                        <TextBlock x:Name="AvailableChipText"
               FontWeight="SemiBold"
               Foreground="#333"
               Text="Available: 0" />
                    </Border>
                </StackPanel>
            </StackPanel>
        </StackPanel>


        <!-- ===== LINES ===== -->
        <DataGrid Grid.Row="3" x:Name="GridLines" Margin="0,12,0,12" Style="{StaticResource ModernDataGrid}"
                  ItemsSource="{Binding Lines}"
                  RowHeaderWidth="0"
                  CellEditEnding="GridLines_CellEditEnding"
                      PreviewKeyDown="GridLines_PreviewKeyDown">
            <DataGrid.Columns>
                <DataGridTextColumn Header="Item ID" Binding="{Binding ItemId}" IsReadOnly="True" Width="80"/>
                <DataGridTextColumn Header="SKU" Binding="{Binding Sku}" IsReadOnly="True" Width="120"/>
                <DataGridTextColumn Header="Item" Binding="{Binding DisplayName}" IsReadOnly="True" Width="*"/>
                <DataGridTextColumn Header="Unit Cost" Binding="{Binding UnitCost, UpdateSourceTrigger=PropertyChanged, StringFormat=N2}" Width="100" />
                <DataGridTextColumn Header="Disc" Binding="{Binding Discount, StringFormat={}{0:N2}}" Width="90"/>
                <DataGridTextColumn Header="Tax %" Binding="{Binding TaxRate, StringFormat={}{0:N2}}" Width="90"/>
                <DataGridTextColumn Header="Max" Binding="{Binding MaxReturnQty, StringFormat={}{0:N2}}" IsReadOnly="True" Width="80"/>
                <DataGridTextColumn Header="Return Qty" Binding="{Binding ReturnQty, UpdateSourceTrigger=PropertyChanged, StringFormat=N2}" Width="100"/>
                <DataGridTextColumn Header="Line Total" Binding="{Binding LineTotal, StringFormat={}{0:N2}}" IsReadOnly="True" Width="120"/>
            </DataGrid.Columns>
        </DataGrid>

        <!-- ===== TOTALS / ACTIONS ===== -->
        <DockPanel Grid.Row="4" LastChildFill="False">
            
            <StackPanel Orientation="Horizontal" DockPanel.Dock="Right" VerticalAlignment="Center">

                <!-- REFUND PANEL (new) -->
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="Refund:" FontWeight="SemiBold"/>
                    <ComboBox Width="120" SelectedItem="{Binding RefundMethod}"
                              ItemsSource="{Binding RefundMethods}"/>
                    <TextBox Width="100" HorizontalContentAlignment="Right"
                             Text="{Binding RefundAmount, UpdateSourceTrigger=PropertyChanged, StringFormat={}{0:N2}}"/>
                </StackPanel>

                <!-- Totals -->
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="Subtotal:" FontWeight="SemiBold"/>
                    <TextBlock Text="{Binding Subtotal, StringFormat={}{0:N2}}"/>
                </StackPanel>
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="Discount:" FontWeight="SemiBold"/>
                    <TextBlock Text="{Binding Discount, StringFormat={}{0:N2}}"/>
                </StackPanel>
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="Tax:" FontWeight="SemiBold"/>
                    <TextBlock Text="{Binding Tax, StringFormat={}{0:N2}}"/>
                </StackPanel>
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="Other:" FontWeight="SemiBold"/>
                    <TextBox Width="90" HorizontalContentAlignment="Right"
                             Text="{Binding OtherCharges, UpdateSourceTrigger=PropertyChanged, StringFormat={}{0:N2}}"/>
                </StackPanel>
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="Grand:" FontWeight="Bold"/>
                    <TextBlock Text="{Binding GrandTotal, StringFormat={}{0:N2}}" FontWeight="Bold"/>
                </StackPanel>
                
            </StackPanel>
        </DockPanel>
    </Grid>
</Window>
